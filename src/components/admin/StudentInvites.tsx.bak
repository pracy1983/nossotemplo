import React, { useState, useEffect } from 'react';
import { Mail, Send, Copy, Check, AlertTriangle, UserCheck, X, Plus, Search, Filter, Link, ChevronLeft, ChevronRight, Edit, CheckSquare, Square } from 'lucide-react';
import { useData } from '../../contexts/DataContext';
import { InviteData, Student } from '../../types';
import { generateId, validateEmail } from '../../utils/helpers';
import Modal from '../common/Modal';

const StudentInvites: React.FC = () => {
  const { students, temples, addStudent } = useData();
  const [showInviteModal, setShowInviteModal] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<'all' | 'pending' | 'accepted' | 'expired'>('all');
  const [filterUnit, setFilterUnit] = useState<'all' | string>('all');
  const [isSending, setIsSending] = useState(false);
  const [copiedToken, setCopiedToken] = useState<string | null>(null);
  const [generatedLink, setGeneratedLink] = useState<string | null>(null);
  const [showLinkModal, setShowLinkModal] = useState(false);
  
  // Novas variáveis de estado para as funcionalidades solicitadas
  const [selectedStudents, setSelectedStudents] = useState<Set<string>>(new Set());
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage] = useState(10);
  const [showEmailTemplateModal, setShowEmailTemplateModal] = useState(false);
  const [emailTemplate, setEmailTemplate] = useState({
    subject: 'Convite para o Nosso Templo',
    body: 'Olá {{nome}},\n\nVocê foi convidado para participar do Nosso Templo.\n\nClique no link abaixo para aceitar o convite:\n{{link}}\n\nAtenciosamente,\nEquipe Nosso Templo'
  });
  const [showSendEmailsModal, setShowSendEmailsModal] = useState(false);

  const [inviteForm, setInviteForm] = useState<InviteData>({
    fullName: '',
    email: '',
    unit: temples.length > 0 ? temples[0].abbreviation : 'SP',
    turma: '',
    invitedBy: 'Administrador'
  });

  const [errors, setErrors] = useState<Record<string, string>>({});

  // Funções para manipular a seleção de membros
  const handleSelectStudent = (studentId: string) => {
    const newSelected = new Set(selectedStudents);
    if (newSelected.has(studentId)) {
      newSelected.delete(studentId);
    } else {
      newSelected.add(studentId);
    }
    setSelectedStudents(newSelected);
  };

  const handleSelectAll = (students: Student[]) => {
    if (selectedStudents.size === students.length) {
      // Se todos estão selecionados, desmarca todos
      setSelectedStudents(new Set());
    } else {
      // Seleciona todos os estudantes da página atual
      const newSelected = new Set<string>();
      students.forEach(student => {
        if (student.id) {
          newSelected.add(student.id);
        }
      });
      setSelectedStudents(newSelected);
    }
  };

  // Funções para paginação
  const handlePageChange = (newPage: number) => {
    setCurrentPage(newPage);
  };

  // Funções para manipular o template de e-mail
  const handleEditTemplate = () => {
    setShowEmailTemplateModal(true);
  };

  const handleSaveTemplate = (newTemplate: {subject: string, body: string}) => {
    setEmailTemplate(newTemplate);
    setShowEmailTemplateModal(false);
  };

  // Função para enviar e-mails
  const handleSendEmails = async () => {
    if (selectedStudents.size === 0) return;
    
    setIsSending(true);
    setShowSendEmailsModal(true);
    
    try {
      // Aqui você implementaria a lógica de envio de e-mails
      // Usando os dados do template e os estudantes selecionados
      
      // Simulando o envio
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      alert(`${selectedStudents.size} e-mails enviados com sucesso!`);
      setSelectedStudents(new Set());
    } catch (error) {
      console.error('Erro ao enviar e-mails:', error);
      alert('Erro ao enviar e-mails. Tente novamente.');
    } finally {
      setIsSending(false);
      setShowSendEmailsModal(false);
    }
  };

  // Get students with invite information
  const invitedStudents = students.filter(student => 
    student.inviteStatus || student.isPendingApproval
  );

  // Filter invited students
  const filteredInvites = invitedStudents.filter(student => {
    const matchesSearch = student.fullName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         student.email?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesStatus = filterStatus === 'all' || student.inviteStatus === filterStatus;
    const matchesUnit = filterUnit === 'all' || student.unit === filterUnit;
    
    return matchesSearch && matchesStatus && matchesUnit;
  });

  // Paginação
  const indexOfLastItem = currentPage * itemsPerPage;
  const indexOfFirstItem = indexOfLastItem - itemsPerPage;
  const paginatedStudents = filteredInvites.slice(indexOfFirstItem, indexOfLastItem);
  const totalPages = Math.ceil(filteredInvites.length / itemsPerPage);

  // Get pending approvals
  const pendingApprovals = students.filter(student => 
    student.isPendingApproval && student.inviteStatus === 'accepted'
  );

  // Validação do formulário de convite
  const validateInviteForm = () => {
    const newErrors: Record<string, string> = {};
    
    if (!inviteForm.fullName.trim()) {
      newErrors.fullName = 'Nome completo é obrigatório';
    }
    
    if (!inviteForm.email.trim()) {
      newErrors.email = 'Email é obrigatório';
    } else if (!validateEmail(inviteForm.email)) {
      newErrors.email = 'Email inválido';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  // Gerar token de convite
  const generateInviteToken = () => {
    return generateId(16);
  };

  // Gerar link de convite
  const handleGenerateLink = async () => {
    if (!validateInviteForm()) return;
    
    setIsSending(true);
    
    try {
      const token = generateInviteToken();
      const inviteLink = `${window.location.origin}/invite/${token}`;
      
      // Criar novo estudante com status de convite
      const newStudent: Partial<Student> = {
        ...inviteForm,
        id: generateId(),
        inviteToken: token,
        inviteStatus: 'pending',
        inviteSentAt: new Date().toISOString(),
        inviteExpiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 dias
        isActive: false
      };
      
      // Adicionar estudante ao contexto
      addStudent(newStudent as Student);
      
      // Simular envio de email
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setGeneratedLink(inviteLink);
      setShowLinkModal(true);
      setShowInviteModal(false);
      setInviteForm({
        fullName: '',
        email: '',
        unit: temples.length > 0 ? temples[0].abbreviation : 'SP',
        turma: '',
        invitedBy: 'Administrador'
      });
    } catch (error) {
      console.error('Error generating invite:', error);
      alert('Erro ao gerar convite. Tente novamente.');
    } finally {
      setIsSending(false);
    }
  };

  // Enviar convite por email
  const handleSendInvite = async () => {
    if (!validateInviteForm()) return;
    
    setIsSending(true);
    
    try {
      const token = generateInviteToken();
      const inviteLink = `${window.location.origin}/invite/${token}`;
      
      // Criar novo estudante com status de convite
      const newStudent: Partial<Student> = {
        ...inviteForm,
        id: generateId(),
        inviteToken: token,
        inviteStatus: 'pending',
        inviteSentAt: new Date().toISOString(),
        inviteExpiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 dias
        isActive: false
      };
      
      // Adicionar estudante ao contexto
      const updatedStudent = addStudent(newStudent as Student);
      
      // Simular envio de email
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      alert('Convite enviado com sucesso!');
      setShowInviteModal(false);
      setInviteForm({
        fullName: '',
        email: '',
        unit: temples.length > 0 ? temples[0].abbreviation : 'SP',
        turma: '',
        invitedBy: 'Administrador'
      });
    } catch (error) {
      console.error('Error sending invite:', error);
      alert('Erro ao enviar convite. Tente novamente.');
    } finally {
      setIsSending(false);
    }
  };

  // Copiar link de convite
  const handleCopyInviteLink = (token: string) => {
    const inviteLink = `${window.location.origin}/invite/${token}`;
    navigator.clipboard.writeText(inviteLink);
    setCopiedToken(token);
    setTimeout(() => setCopiedToken(null), 2000);
  };

  // Copiar link gerado
  const handleCopyGeneratedLink = () => {
    if (generatedLink) {
      navigator.clipboard.writeText(generatedLink);
      setCopiedToken('generated');
      setTimeout(() => setCopiedToken(null), 2000);
    }
  };

  // Aprovar estudante
  const handleApproveStudent = async (studentId: string) => {
    try {
      // Aqui você implementaria a chamada para atualizar o estudante no banco de dados
      // Por exemplo: await updateStudent(studentId, { isActive: true, inviteStatus: 'accepted' });
      
      // Por enquanto, apenas mostramos um alerta
      alert('Membro aprovado com sucesso!');
    } catch (error) {
      console.error('Error approving student:', error);
      alert('Erro ao aprovar membro. Tente novamente.');
    }
  };

  // Rejeitar estudante
  const handleRejectStudent = async (studentId: string) => {
    if (confirm('Tem certeza que deseja rejeitar este cadastro?')) {
      try {
        // Aqui você implementaria a chamada para remover ou desativar o estudante
        // Por exemplo: await deleteStudent(studentId);
        
        // Por enquanto, apenas mostramos um alerta
        alert('Cadastro rejeitado.');
      } catch (error) {
        console.error('Error rejecting student:', error);
        alert('Erro ao rejeitar cadastro. Tente novamente.');
      }
    }
  };

  // Funções auxiliares para UI
  const getStatusColor = (status?: string) => {
    switch (status) {
      case 'pending':
        return 'text-yellow-400 bg-yellow-400/10';
      case 'accepted':
        return 'text-green-400 bg-green-400/10';
      case 'expired':
        return 'text-red-400 bg-red-400/10';
      default:
        return 'text-gray-400 bg-gray-400/10';
    }
  };

  const getStatusLabel = (status?: string) => {
    switch (status) {
      case 'pending':
        return 'Pendente';
      case 'accepted':
        return 'Aceito';
      case 'expired':
        return 'Expirado';
      default:
        return 'Desconhecido';
    }
  };

  const formatDate = (dateStr?: string) => {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

const StudentInvites: React.FC = () => {
  const { students, temples, addStudent } = useData();
  const [showInviteModal, setShowInviteModal] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<'all' | 'pending' | 'accepted' | 'expired'>('all');
  const [filterUnit, setFilterUnit] = useState<'all' | string>('all');
  const [isSending, setIsSending] = useState(false);
  const [copiedToken, setCopiedToken] = useState<string | null>(null);
  const [generatedLink, setGeneratedLink] = useState<string | null>(null);
  const [showLinkModal, setShowLinkModal] = useState(false);
  
  // Novas variáveis de estado para as funcionalidades solicitadas
  const [selectedStudents, setSelectedStudents] = useState<Set<string>>(new Set());
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage] = useState(10);
  const [showEmailTemplateModal, setShowEmailTemplateModal] = useState(false);
  const [emailTemplate, setEmailTemplate] = useState({
    subject: 'Convite para o Nosso Templo',
    body: 'Olá {{nome}},\n\nVocê foi convidado para participar do Nosso Templo.\n\nClique no link abaixo para aceitar o convite:\n{{link}}\n\nAtenciosamente,\nEquipe Nosso Templo'
  });
  const [showSendEmailsModal, setShowSendEmailsModal] = useState(false);

  const [inviteForm, setInviteForm] = useState<InviteData>({
    fullName: '',
    email: '',
    unit: temples.length > 0 ? temples[0].abbreviation : 'SP',
    turma: '',
    invitedBy: 'Administrador'
  });

  const [errors, setErrors] = useState<Record<string, string>>({});

  // Funções para manipular a seleção de membros
  const handleSelectStudent = (studentId: string) => {
    const newSelected = new Set(selectedStudents);
    if (newSelected.has(studentId)) {
      newSelected.delete(studentId);
    } else {
      newSelected.add(studentId);
    }
    setSelectedStudents(newSelected);
  };

  const handleSelectAll = () => {
    if (selectedStudents.size === paginatedStudents.length) {
      // Se todos estão selecionados, desmarca todos
      setSelectedStudents(new Set());
    } else {
      // Seleciona todos os estudantes da página atual
      const newSelected = new Set<string>();
      paginatedStudents.forEach(student => {
        newSelected.add(student.id);
      });
      setSelectedStudents(newSelected);
    }
  };

  // Funções para paginação
  const handlePageChange = (newPage: number) => {
    setCurrentPage(newPage);
  };

  // Funções para manipular o template de e-mail
  const handleEditTemplate = () => {
    setShowEmailTemplateModal(true);
  };

  const handleSaveTemplate = (newTemplate: {subject: string, body: string}) => {
    setEmailTemplate(newTemplate);
    setShowEmailTemplateModal(false);
  };

  // Função para enviar e-mails
  const handleSendEmails = async () => {
    if (selectedStudents.size === 0) return;
    
    setIsSending(true);
    setShowSendEmailsModal(true);
    
    try {
      // Aqui você implementaria a lógica de envio de e-mails
      // Usando os dados do template e os estudantes selecionados
      
      // Simulando o envio
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      alert(`${selectedStudents.size} e-mails enviados com sucesso!`);
      setSelectedStudents(new Set());
    } catch (error) {
      console.error('Erro ao enviar e-mails:', error);
      alert('Erro ao enviar e-mails. Tente novamente.');
    } finally {
      setIsSending(false);
      setShowSendEmailsModal(false);
    }
  };

  // Get students with invite information
  const invitedStudents = students.filter(student => 
    student.inviteStatus || student.isPendingApproval
  );

  // Filter invited students
  const filteredInvites = invitedStudents.filter(student => {
    const matchesSearch = student.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         student.email.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesStatus = filterStatus === 'all' || student.inviteStatus === filterStatus;
    const matchesUnit = filterUnit === 'all' || student.unit === filterUnit;
    
    return matchesSearch && matchesStatus && matchesUnit;
  });

  // Paginação
  const indexOfLastItem = currentPage * itemsPerPage;
  const indexOfFirstItem = indexOfLastItem - itemsPerPage;
  const paginatedStudents = filteredInvites.slice(indexOfFirstItem, indexOfLastItem);
  const totalPages = Math.ceil(filteredInvites.length / itemsPerPage);

  // Get pending approvals
  const pendingApprovals = students.filter(student => 
    student.isPendingApproval && student.inviteStatus === 'accepted'
  );

  const validateInviteForm = () => {
    const newErrors: Record<string, string> = {};

    if (!inviteForm.fullName.trim()) {
      newErrors.fullName = 'Nome completo é obrigatório';
    }

    if (!inviteForm.email.trim()) {
      newErrors.email = 'Email é obrigatório';
    } else if (!validateEmail(inviteForm.email)) {
      newErrors.email = 'Email inválido';
    } else {
      // Check for duplicate email
      const existingStudent = students.find(s => 
        s.email.toLowerCase() === inviteForm.email.toLowerCase()
      );
      if (existingStudent) {
        newErrors.email = 'Já existe um membro com este email';
      }
    }

    if (!inviteForm.unit) {
      newErrors.unit = 'Templo é obrigatório';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const generateInviteToken = () => {
    return Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
  };

  const handleGenerateLink = async () => {
    if (!validateInviteForm()) return;

    setIsSending(true);

    try {
      const inviteToken = generateInviteToken();
      const inviteUrl = `${window.location.origin}/convite/${inviteToken}`;

      const newStudent: Student = {
        id: generateId(),
        fullName: inviteForm.fullName,
        email: inviteForm.email,
        unit: inviteForm.unit,
        turma: inviteForm.turma,
        birthDate: '1900-01-01', // Placeholder date for invites
        cpf: '',
        rg: '',
        phone: '',
        religion: '',
        isFounder: false,
        isActive: false, // Will be activated after approval
        attendance: [],
        isAdmin: false,
        isGuest: false,
        role: 'student',
        inviteStatus: 'pending',
        inviteToken,
        invitedAt: new Date().toISOString(),
        invitedBy: inviteForm.invitedBy,
        isPendingApproval: false
      };

      await addStudent(newStudent);

      // Set the generated link for display
      setGeneratedLink(inviteUrl);
      setShowLinkModal(true);

      // Reset form
      setInviteForm({
        fullName: '',
        email: '',
        unit: temples.length > 0 ? temples[0].abbreviation : 'SP',
        turma: '',
        invitedBy: 'Administrador'
      });
      setErrors({});
      setShowInviteModal(false);

    } catch (error: any) {
      console.error('Error generating invite link:', error);
      alert('Erro ao gerar link de convite. Tente novamente.');
    } finally {
      setIsSending(false);
    }
  };

  const handleSendInvite = async () => {
    if (!validateInviteForm()) return;

    setIsSending(true);

    try {
      const inviteToken = generateInviteToken();
      const inviteUrl = `${window.location.origin}/convite/${inviteToken}`;

      const newStudent: Student = {
        id: generateId(),
        fullName: inviteForm.fullName,
        email: inviteForm.email,
        unit: inviteForm.unit,
        turma: inviteForm.turma,
        birthDate: '1900-01-01', // Placeholder date for invites
        cpf: '',
        rg: '',
        phone: '',
        religion: '',
        isFounder: false,
        isActive: false, // Will be activated after approval
        attendance: [],
        isAdmin: false,
        isGuest: false,
        role: 'student',
        inviteStatus: 'pending',
        inviteToken,
        invitedAt: new Date().toISOString(),
        invitedBy: inviteForm.invitedBy,
        isPendingApproval: false
      };

      await addStudent(newStudent);

      // Set the generated link for display
      setGeneratedLink(inviteUrl);
      setShowLinkModal(true);

      // Show success message
      alert('Email foi enviado com sucesso!');

      // Reset form
      setInviteForm({
        fullName: '',
        email: '',
        unit: temples.length > 0 ? temples[0].abbreviation : 'SP',
        turma: '',
        invitedBy: 'Administrador'
      });
      setErrors({});
      setShowInviteModal(false);

    } catch (error: any) {
      console.error('Error sending invite:', error);
      alert('Erro ao enviar convite. Tente novamente.');
    } finally {
      setIsSending(false);
    }
  };

  const handleCopyInviteLink = (token: string) => {
    const inviteUrl = `${window.location.origin}/convite/${token}`;
    navigator.clipboard.writeText(inviteUrl);
    setCopiedToken(token);
    setTimeout(() => setCopiedToken(null), 2000);
  };

  const handleCopyGeneratedLink = () => {
    if (generatedLink) {
      navigator.clipboard.writeText(generatedLink);
      setCopiedToken('generated');
      setTimeout(() => setCopiedToken(null), 2000);
    }
  };

  const handleApproveStudent = async (studentId: string) => {
    try {
      // Update student to approved status
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const updatedStudent = {
        ...student,
        isActive: true,
        isPendingApproval: false,
        inviteStatus: 'accepted' as const
      };

      // In a real app, you would call updateStudent here
      alert('Membro aprovado com sucesso!');
    } catch (error) {
      console.error('Error approving student:', error);
      alert('Erro ao aprovar membro. Tente novamente.');
    }
  };

  const handleRejectStudent = async (studentId: string) => {
    if (confirm('Tem certeza que deseja rejeitar este cadastro?')) {
      try {
        // In a real app, you would call deleteStudent here
        alert('Cadastro rejeitado.');
      } catch (error) {
        console.error('Error rejecting student:', error);
        alert('Erro ao rejeitar cadastro. Tente novamente.');
      }
    }
  };

  const getStatusColor = (status?: string) => {
    switch (status) {
      case 'pending':
        return 'text-yellow-400 bg-yellow-400/10';
      case 'accepted':
        return 'text-green-400 bg-green-400/10';
      case 'expired':
        return 'text-red-400 bg-red-400/10';
      default:
        return 'text-gray-400 bg-gray-400/10';
    }
  };

  const getStatusLabel = (status?: string) => {
    switch (status) {
      case 'pending':
        return 'Pendente';
      case 'accepted':
        return 'Aceito';
      case 'expired':
        return 'Expirado';
      default:
        return 'Desconhecido';
    }
  };

  const formatDate = (dateStr?: string) => {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };


};



return (
<div className="space-y-6">
  <div className="flex justify-between items-center">
    <h2 className="text-xl font-semibold text-white">
      Convites e Aprovações
      {pendingApprovals.length > 0 && (
        <span className="ml-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full">
          {pendingApprovals.length}
        </span>
      )}
    </h2>
    <div className="flex space-x-3">
      <button
        onClick={handleEditTemplate}
        className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors text-white flex items-center space-x-2"
      >
        <Edit className="w-4 h-4" />
        <span>Editar Template</span>
      </button>
      <button
        onClick={handleSendEmails}
        disabled={selectedStudents.size === 0 || isSending}
        className="bg-green-600 hover:bg-green-700 disabled:bg-green-600/50 px-4 py-2 rounded-lg transition-colors text-white flex items-center space-x-2"
      >
        <Mail className="w-4 h-4" />
        <span>{isSending ? 'Enviando...' : 'Enviar E-mails'}</span>
      </button>
      <button
        onClick={() => setShowInviteModal(true)}
        className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors text-white flex items-center space-x-2"
      >
        <Plus className="w-4 h-4" />
        <span>Novo Convite</span>
      </button>
    </div>
  </div>

  {/* Pending Approvals Alert */}
  {pendingApprovals.length > 0 && (
    <div className="bg-yellow-600/10 border border-yellow-600/20 rounded-xl p-6">
      <div className="flex items-center space-x-3">
        <AlertTriangle className="w-6 h-6 text-yellow-400" />
        <div>
          <h3 className="text-yellow-400 font-semibold">
            {pendingApprovals.length} cadastro(s) aguardando aprovação
          </h3>
          <p className="text-yellow-300 text-sm">
            Há novos membros que completaram o cadastro e aguardam sua aprovação.
          </p>
        </div>
      </div>
    </div>
  )}

  {/* Filters */}
  <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
    <div className="flex flex-col lg:flex-row lg:items-center space-y-4 lg:space-y-0 lg:space-x-4">
      {/* Search */}
      <div className="flex-1">
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
          <input
            type="text"
            placeholder="Buscar por nome ou email..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-11 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:border-red-600 focus:ring-1 focus:ring-red-600"
          />
          <div className="flex items-center space-x-3">
            <AlertTriangle className="w-6 h-6 text-yellow-400" />
            <div>
              <h3 className="text-yellow-400 font-semibold">
                {pendingApprovals.length} cadastro(s) aguardando aprovação
              </h3>
              <p className="text-yellow-300 text-sm">
                Há novos membros que completaram o cadastro e aguardam sua aprovação.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Filters */}
      <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
        <div className="flex flex-col lg:flex-row lg:items-center space-y-4 lg:space-y-0 lg:space-x-4">
          {/* Search */}
          <div className="flex-1">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
              <input
                type="text"
                placeholder="Buscar por nome ou email..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-11 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:border-red-600 focus:ring-1 focus:ring-red-600"
              />
            </div>
          </div>

          {/* Filters */}
          <div className="flex items-center space-x-4">
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value as any)}
              className="px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
            >
              <option value="all">Todos os Status</option>
              <option value="pending">Pendente</option>
              <option value="accepted">Aceito</option>
              <option value="expired">Expirado</option>
            </select>

            <select
              value={filterUnit}
              onChange={(e) => setFilterUnit(e.target.value)}
              className="px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
            >
              <option value="all">Todos os Templos</option>
              {temples.map(temple => (
                <option key={temple.id} value={temple.abbreviation}>
                  Templo {temple.abbreviation} - {temple.city}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* Pending Approvals Section */}
      {pendingApprovals.length > 0 && (
        <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
          <h2 className="text-xl font-semibold text-white mb-6 flex items-center space-x-2">
            <UserCheck className="w-6 h-6 text-green-400" />
            <span>Aguardando Aprovação ({pendingApprovals.length})</span>
          </h2>
          
          <div className="space-y-4">
            {pendingApprovals.map(student => (
              <div key={student.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <h3 className="font-semibold text-white">{student.fullName}</h3>
                    <div className="text-sm text-gray-400 mt-1">
                      <p>{student.email}</p>
                      <p>Templo {student.unit} • {student.turma && `Turma: ${student.turma}`}</p>
                      <p>Cadastro completado em: {formatDate(student.invitedAt)}</p>
                    </div>
                  </div>
                  
                  <div className="flex items-center space-x-3">
                    <button
                      onClick={() => handleRejectStudent(student.id)}
                      className="flex items-center space-x-2 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors"
                    >
                      <X className="w-4 h-4" />
                      <span>Rejeitar</span>
                    </button>
                    
                    <button
                      onClick={() => handleApproveStudent(student.id)}
                      className="flex items-center space-x-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors"
                    >
                      <Check className="w-4 h-4" />
                      <span>Aprovar</span>
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Invites List */}
      <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-semibold text-white flex items-center space-x-2">
            <Mail className="w-6 h-6 text-red-400" />
            <span>Convites Enviados ({filteredInvites.length})</span>
          </h2>
          
          {selectedStudents.size > 0 && (
            <div className="flex items-center space-x-3">
              <button
                onClick={() => handleSendEmails()}
                className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors"
                disabled={isSending}
              >
                <Send className="w-4 h-4" />
                <span>Enviar Email ({selectedStudents.size})</span>
              </button>
              
              <button
                onClick={() => {
                  if (confirm(`Tem certeza que deseja aprovar ${selectedStudents.size} membros?`)) {
                    Array.from(selectedStudents).forEach(id => handleApproveStudent(id));
                    setSelectedStudents(new Set());
                  }
                }}
                className="flex items-center space-x-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors"
              >
                <Check className="w-4 h-4" />
                <span>Aprovar ({selectedStudents.size})</span>
              </button>
              
              <button
                onClick={() => {
                  if (confirm(`Tem certeza que deseja rejeitar ${selectedStudents.size} membros?`)) {
                    Array.from(selectedStudents).forEach(id => handleRejectStudent(id));
                    setSelectedStudents(new Set());
                  }
                }}
                className="flex items-center space-x-2 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors"
              >
                <X className="w-4 h-4" />
                <span>Rejeitar ({selectedStudents.size})</span>
              </button>
            </div>
          )}
        </div>
        
        {filteredInvites.length > 0 ? (
          <div className="space-y-4">
            {/* Tabela de membros */}
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-800 border-b border-gray-700">
                    <th className="p-3 text-left">
                      <div className="flex items-center">
                        <button 
                          onClick={() => handleSelectAll(paginatedStudents)}
                          className="text-gray-400 hover:text-white focus:outline-none"
                        >
                          {selectedStudents.size === paginatedStudents.length ? (
                            <CheckSquare className="w-5 h-5" />
                          ) : (
                            <Square className="w-5 h-5" />
                          )}
                        </button>
                      </div>
                    </th>
                    <th className="p-3 text-left text-sm font-medium text-gray-300">Nome</th>
                    <th className="p-3 text-left text-sm font-medium text-gray-300">Email</th>
                    <th className="p-3 text-left text-sm font-medium text-gray-300">Templo</th>
                    <th className="p-3 text-left text-sm font-medium text-gray-300">Status</th>
                    <th className="p-3 text-left text-sm font-medium text-gray-300">Data</th>
                    <th className="p-3 text-left text-sm font-medium text-gray-300">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {paginatedStudents.map(student => (
                    <tr key={student.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                      <td className="p-3">
                        <button 
                          onClick={() => handleSelectStudent(student.id)}
                          className="text-gray-400 hover:text-white focus:outline-none"
                        >
                          {selectedStudents.has(student.id) ? (
                            <CheckSquare className="w-5 h-5" />
                          ) : (
                            <Square className="w-5 h-5" />
                          )}
                        </button>
                      </td>
                      <td className="p-3">
                        <span className="font-medium text-white">{student.fullName}</span>
                      </td>
                      <td className="p-3 text-sm text-gray-300">{student.email}</td>
                      <td className="p-3 text-sm text-gray-300">
                        {student.unit} {student.turma && `• Turma ${student.turma}`}
                      </td>
                      <td className="p-3">
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(student.inviteStatus)}`}>
                          {getStatusLabel(student.inviteStatus)}
                        </span>
                      </td>
                      <td className="p-3 text-sm text-gray-300">
                        {formatDate(student.invitedAt)}
                      </td>
                      <td className="p-3">
                        <div className="flex items-center space-x-2">
                          {student.inviteStatus === 'pending' && student.inviteToken && (
                            <button
                              onClick={() => handleCopyInviteLink(student.inviteToken!)}
                              className="p-1 text-blue-400 hover:text-blue-300 focus:outline-none"
                              title="Copiar Link"
                            >
                              {copiedToken === student.inviteToken ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                            </button>
                          )}
                          
                          {student.inviteStatus === 'accepted' && student.isPendingApproval && (
                            <>
                              <button
                                onClick={() => handleApproveStudent(student.id)}
                                className="p-1 text-green-400 hover:text-green-300 focus:outline-none"
                                title="Aprovar"
                              >
                                <Check className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleRejectStudent(student.id)}
                                className="p-1 text-red-400 hover:text-red-300 focus:outline-none"
                                title="Rejeitar"
                              >
                                <X className="w-4 h-4" />
                              </button>
                            </>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            
            {/* Paginação */}
            {totalPages > 1 && (
              <div className="flex justify-center items-center space-x-2 mt-6">
                <button
                  onClick={() => handlePageChange(currentPage - 1)}
                  disabled={currentPage === 1}
                  className={`p-2 rounded-md ${currentPage === 1 ? 'text-gray-600' : 'text-gray-300 hover:bg-gray-800'}`}
                >
                  <ChevronLeft className="w-5 h-5" />
                </button>
                
                {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                  <button
                    key={page}
                    onClick={() => handlePageChange(page)}
                    className={`px-3 py-1 rounded-md ${currentPage === page ? 'bg-red-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}
                  >
                    {page}
                  </button>
                ))}
                
                <button
                  onClick={() => handlePageChange(currentPage + 1)}
                  disabled={currentPage === totalPages}
                  className={`p-2 rounded-md ${currentPage === totalPages ? 'text-gray-600' : 'text-gray-300 hover:bg-gray-800'}`}
                >
                  <ChevronRight className="w-5 h-5" />
                </button>
              </div>
            )}
          </div>
        ) : (
          <div className="text-center py-8">
            <Mail className="w-12 h-12 text-gray-600 mx-auto mb-4" />
            <h3 className="text-lg font-medium text-gray-400 mb-2">
              Nenhum convite encontrado
            </h3>
            <p className="text-gray-500">
              {searchTerm || filterStatus !== 'all' || filterUnit !== 'all'
                ? 'Tente ajustar os filtros de busca'
                : 'Clique em "Enviar Convite" para convidar novos membros'
              }
            </p>
          </div>
        )}
      </div>

      {/* Send Invite Modal */}
      <Modal
        isOpen={showInviteModal}
        onClose={() => {
          setShowInviteModal(false);
          setErrors({});
        }}
        title="Enviar Convite para Novo Membro"
        size="lg"
      >
        <form onSubmit={(e) => { e.preventDefault(); }} className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Nome Completo *
              </label>
              <input
                type="text"
                value={inviteForm.fullName}
                onChange={(e) => setInviteForm(prev => ({ ...prev, fullName: e.target.value }))}
                className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
                placeholder="Nome completo do novo membro"
              />
              {errors.fullName && <p className="text-red-400 text-sm mt-1">{errors.fullName}</p>}
            </div>

            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Email *
              </label>
              <input
                type="email"
                value={inviteForm.email}
                onChange={(e) => setInviteForm(prev => ({ ...prev, email: e.target.value }))}
                className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
                placeholder="email@exemplo.com"
              />
              {errors.email && <p className="text-red-400 text-sm mt-1">{errors.email}</p>}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Templo *
              </label>
              <select
                value={inviteForm.unit}
                onChange={(e) => setInviteForm(prev => ({ ...prev, unit: e.target.value }))}
                className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
              >
                {temples.map(temple => (
                  <option key={temple.id} value={temple.abbreviation}>
                    Templo {temple.abbreviation} - {temple.city}
                  </option>
                ))}
                {temples.length === 0 && (
                  <>
                    <option value="SP">Templo SP - São Paulo</option>
                    <option value="BH">Templo BH - Belo Horizonte</option>
                    <option value="CP">Templo CP - Campinas</option>
                  </>
                )}
              </select>
              {errors.unit && <p className="text-red-400 text-sm mt-1">{errors.unit}</p>}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Turma/Grupo
              </label>
              <input
                type="text"
                value={inviteForm.turma}
                onChange={(e) => setInviteForm(prev => ({ ...prev, turma: e.target.value }))}
                className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
                placeholder="Ex: Turma A, Iniciantes, etc."
              />
            </div>

            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Enviado por
              </label>
              <input
                type="text"
                value={inviteForm.invitedBy}
                onChange={(e) => setInviteForm(prev => ({ ...prev, invitedBy: e.target.value }))}
                className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-600 focus:ring-1 focus:ring-red-600"
                placeholder="Seu nome ou identificação"
              />
            </div>
          </div>

          <div className="bg-blue-600/10 border border-blue-600/20 rounded-lg p-4">
            <div className="flex items-start space-x-3">
              <Mail className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
              <div>
                <p className="text-blue-400 text-sm font-medium mb-1">
                  Como funciona o convite
                </p>
                <ul className="text-blue-300 text-xs space-y-1">
                  <li>• Um link único será gerado para o novo membro</li>
                  <li>• O link expira em 7 dias após o envio</li>
                  <li>• O membro preencherá seus dados pessoais</li>
                  <li>• Após completar o cadastro, você receberá uma notificação para aprovação</li>
                  <li>• Somente após sua aprovação o membro terá acesso ao sistema</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="flex justify-end space-x-3">
            <button
              type="button"
              onClick={() => {
                setShowInviteModal(false);
                setErrors({});
              }}
              className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors"
            >
              Cancelar
            </button>
            
            <button
              type="button"
              onClick={handleGenerateLink}
              disabled={isSending}
              className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-600/50 px-4 py-2 rounded-lg transition-colors"
            >
              <Link className="w-4 h-4" />
              <span>{isSending ? 'Gerando...' : 'Gerar Link'}</span>
            </button>
            
            <button
              type="button"
              onClick={handleSendInvite}
              disabled={isSending}
              className="flex items-center space-x-2 bg-red-600 hover:bg-red-700 disabled:bg-red-600/50 px-4 py-2 rounded-lg transition-colors"
            >
              <Send className="w-4 h-4" />
              <span>{isSending ? 'Enviando...' : 'Enviar Convite'}</span>
            </button>
          </div>
        </form>
      </Modal>

      {/* Generated Link Modal */}
      <Modal
        isOpen={showLinkModal}
        onClose={() => {
          setShowLinkModal(false);
          setGeneratedLink(null);
        }}
        title="Link de Convite Gerado"
        size="lg"
      >
        <div className="space-y-6">
          <div className="bg-green-600/10 border border-green-600/20 rounded-lg p-4">
            <div className="flex items-center space-x-3 mb-3">
              <Check className="w-5 h-5 text-green-400" />
              <h4 className="font-medium text-green-400">Convite criado com sucesso!</h4>
            </div>
            <p className="text-green-300 text-sm">
              O email foi enviado e você pode copiar o mesmo link que foi enviado.
            </p>
          </div>

          {generatedLink && (
            <div className="space-y-3">
              <label className="block text-sm font-medium text-gray-300">
                Link do Convite:
              </label>
              <div className="bg-gray-800 rounded-lg p-3 border border-gray-700">
                <code className="text-sm text-gray-300 break-all block">{generatedLink}</code>
              </div>
              <button
                onClick={handleCopyGeneratedLink}
                className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors"
              >
                {copiedToken === 'generated' ? (
                  <>
                    <Check className="w-4 h-4" />
                    <span>Copiado!</span>
                  </>
                ) : (
                  <>
                    <Copy className="w-4 h-4" />
                    <span>Copiar</span>
                  </>
                )}
              </button>
            </div>
          )}

          <div className="bg-blue-600/10 border border-blue-600/20 rounded-lg p-4">
            <div className="flex items-start space-x-3">
              <AlertTriangle className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
              <div>
                <p className="text-blue-400 text-sm font-medium mb-1">
                  Próximos passos
                </p>
                <ul className="text-blue-300 text-xs space-y-1">
                  <li>• O link foi enviado por email para o novo membro</li>
                  <li>• Você pode compartilhar o link copiado se necessário</li>
                  <li>• O link expira em 7 dias</li>
                  <li>• Quando o membro completar o cadastro, você será notificado para aprovação</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="flex justify-end">
            <button
              onClick={() => {
                setShowLinkModal(false);
                setGeneratedLink(null);
              }}
              className="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors"
            >
              Fechar
            </button>
          </div>
        </div>
      </Modal>
    </div>
  );
};

export default StudentInvites;